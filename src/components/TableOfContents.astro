---
const { headings } = Astro.props

interface Heading {
    depth: number
    slug: string
    text: string
}
---

<nav class="toc">
    <ul class="border-base-200 space-y-0 border-l-2 text-[0.9em]">
        {
            headings.map((heading: Heading) => (
                <li class={`toc-level-${heading.depth} relative`}>
                    <a
                        href={`#${heading.slug}`}
                        class={`-ms-0.5 block border-l-2 py-2 pr-4 transition-all duration-300 ${heading.depth === 2 ? 'pl-4 font-medium' : 'pl-8 text-sm'} text-base-content/60 hover:border-primary/50 hover:text-primary data-[active=true]:border-primary data-[active=true]:text-primary data-[active=true]:bg-base-200/50 border-transparent`}
                    >
                        {heading.text}
                    </a>
                </li>
            ))
        }
    </ul>
</nav>

<script>
    const visibleHeadings = new Map()

    const observer = new IntersectionObserver(
        (entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    visibleHeadings.set(entry.target.getAttribute('id'), entry)
                } else {
                    visibleHeadings.delete(entry.target.getAttribute('id'))
                }
            })

            const visibleIds = Array.from(visibleHeadings.keys())
            let activeId = ''

            if (visibleIds.length > 0) {
                const allLinks = document.querySelectorAll('.toc a')
                for (const link of allLinks) {
                    const href = link.getAttribute('href')?.substring(1)
                    if (visibleHeadings.has(href)) {
                        activeId = href ?? ''
                        break
                    }
                }
            }

            if (activeId) {
                document.querySelectorAll('.toc a').forEach((l) => {
                    l.removeAttribute('data-active')
                })
                const activeLink = document.querySelector(`.toc a[href="#${activeId}"]`)
                activeLink?.setAttribute('data-active', 'true')
            }
        },
        { rootMargin: '-100px 0% -66% 0%', threshold: 0 },
    )

    document.querySelectorAll('article :is(h1, h2, h3, h4)').forEach((h) => {
        observer.observe(h)
    })

    document.querySelectorAll('.toc a').forEach((link) => {
        link.addEventListener('click', (e) => {
            document.querySelectorAll('.toc a').forEach((l) => {
                l.removeAttribute('data-active')
            })
            ;(e.currentTarget as Element).setAttribute('data-active', 'true')
        })
    })
</script>
