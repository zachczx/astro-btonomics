---
import Layout from '../layouts/Layout.astro'
import { Image } from 'astro:assets'
import { CleanAndSort } from '../lib/utils'
import headerImage2 from '../images/36_upload_IMG_20180730_204953_header.jpg'
import headerImage1 from '../images/3_concept1_header-topaz-enhance-4x.webp'
import dayjs from 'dayjs'
import relativeTime from 'dayjs/plugin/relativeTime'
import { categories } from '../data/categories'

dayjs.extend(relativeTime)

const allPosts = await CleanAndSort()
allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())

const latestPosts = allPosts.slice(0, 6)

const categoryCounts: Record<string, number> = {}
categories.forEach((cat) => {
    const catTags = cat.tags.map((t) => t.toLowerCase())
    const count = allPosts.filter((post) => {
        const postTags = (post.data.tags || []).map((t) => t.toLowerCase())
        return postTags.some((t) => catTags.includes(t))
    }).length
    categoryCounts[cat.slug] = count
})

const formatDate = (date: Date) => dayjs(date).fromNow()
---

<Layout title="Home">
    <div slot="hero" class="bg-base-200/50 py-12 md:py-16">
        <div class="container mx-auto px-4">
            <div class="mx-auto grid max-w-5xl grid-cols-1 gap-12 md:grid-cols-2 md:gap-16">
                <a
                    href={`/renovation/our-clean-bto-home-design`}
                    class="group block rotate-1 transition-all duration-500 hover:scale-105"
                >
                    <div class="bg-white p-6 shadow-md transition-shadow duration-500">
                        <div class="bg-base-200 mb-6 aspect-4/3 overflow-hidden">
                            <Image
                                src={headerImage1}
                                alt="The start"
                                width={960}
                                height={720}
                                class="h-full w-full object-cover grayscale transition-all duration-700 group-hover:grayscale-0"
                                loading="eager"
                            />
                        </div>
                        <div class="text-center">
                            <h2
                                class="text-base-content group-hover:text-primary mb-1 text-3xl font-bold transition-colors"
                            >
                                The Concept
                            </h2>
                            <p class="text-base-content/70 text-sm leading-relaxed">
                                Planning, decisions, and lessons learned
                            </p>
                        </div>
                    </div>
                </a>

                <a
                    href={`/renovation/our-clean-bto-home-design`}
                    class="group block transition-all duration-500 hover:scale-105"
                >
                    <div class="-rotate-1 bg-white p-6 shadow-md transition-shadow duration-500">
                        <div class="bg-base-200 mb-6 aspect-4/3 overflow-hidden">
                            <Image
                                src={headerImage2}
                                alt="The end"
                                width={960}
                                height={720}
                                class="h-full w-full object-cover transition-transform duration-700 group-hover:scale-105"
                                loading="eager"
                            />
                        </div>
                        <div class="text-center">
                            <h2
                                class="text-base-content group-hover:text-primary mb-1 text-3xl font-bold transition-colors"
                            >
                                The Result
                            </h2>
                            <p class="text-base-content/70 text-sm leading-relaxed">
                                Real transformations and honest reviews
                            </p>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <main class="bg-base-200/30 space-y-20 py-12 md:py-16">
        <section class="container mx-auto px-4">
            <div class="mb-4 flex items-end justify-between md:mb-8">
                <div>
                    <h2 class="text-base-content mb-1 text-3xl font-bold md:text-4xl">
                        Latest Happenings
                    </h2>
                </div>
                <a
                    href="/blog"
                    class="text-primary hover:text-secondary flex items-center gap-1 text-sm font-bold transition-colors"
                >
                    See All
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"
                            clip-rule="evenodd"></path>
                    </svg>
                </a>
            </div>

            <div class="grid grid-cols-1 gap-4 md:grid-cols-2 md:gap-8 lg:grid-cols-3">
                {
                    latestPosts.map((post, index) => {
                        const badgeColors = ['badge-primary', 'badge-secondary', 'badge-accent']
                        const badgeColor = badgeColors[index % 3]

                        return (
                            <article
                                class={`group transition-all duration-500 hover:scale-102 hover:rotate-[0.5deg]`}
                            >
                                <a href={`/${post.data.category}/${post.data.slug}`} class="block">
                                    <div class="bg-white p-4 shadow transition-shadow duration-500 hover:shadow-md">
                                        <div class="bg-base-200 relative mb-4 aspect-square overflow-hidden">
                                            {post.data.image && (
                                                <Image
                                                    src={post.data.image}
                                                    alt={post.data.title}
                                                    width={600}
                                                    height={600}
                                                    class="h-full w-full object-cover"
                                                />
                                            )}
                                            <div class="absolute top-2 right-2">
                                                <span
                                                    class={`badge ${badgeColor} badge-sm font-semibold shadow-md`}
                                                >
                                                    {post.data.tags?.[0] || 'Post'}
                                                </span>
                                            </div>
                                        </div>

                                        <div class="text-center">
                                            <h3 class="group-hover:text-primary mb-2 line-clamp-2 text-lg leading-tight font-bold transition-colors">
                                                {post.data.title}
                                            </h3>
                                            <time class="text-base-content/60 block text-xs">
                                                {formatDate(post.data.pubDate)}
                                            </time>
                                        </div>
                                    </div>
                                </a>
                            </article>
                        )
                    })
                }
            </div>
        </section>

        <section class="bg-base-200/30 py-20">
            <div class="container mx-auto px-4">
                <div class="mb-12 text-center">
                    <h2 class="text-base-content mb-3 text-4xl font-bold md:text-5xl">
                        Browse by Topic
                    </h2>
                    <p class="text-base-content/60">Filed and organized for you</p>
                </div>

                <div
                    class="mx-auto grid max-w-6xl grid-cols-1 gap-8 sm:grid-cols-2 md:gap-10 lg:grid-cols-3"
                >
                    {
                        categories.map((cat, index) => {
                            const rotations = [
                                'rotate-1',
                                '-rotate-1',
                                'rotate-2',
                                '-rotate-1',
                                'rotate-1',
                                '-rotate-2',
                            ]
                            const rotation = rotations[index % rotations.length]

                            return (
                                <a
                                    href={`/${cat.slug}`}
                                    class={`group block ${rotation} transition-all duration-500 hover:scale-105 hover:rotate-0`}
                                >
                                    <div class="bg-white p-6 shadow-md transition-shadow duration-500 hover:shadow-lg">
                                        <div class="bg-base-200/30 group-hover:bg-primary/5 mb-4 flex aspect-square items-center justify-center transition-colors">
                                            <div class="text-8xl">
                                                <cat.icon />
                                            </div>
                                        </div>

                                        <div class="text-center">
                                            <h3 class="text-base-content group-hover:text-primary mb-2 text-xl font-bold transition-colors">
                                                {cat.name}
                                            </h3>

                                            <div class="text-base-content/60 mb-3 text-xs">
                                                {categoryCounts[cat.slug]} posts
                                            </div>

                                            <p class="text-base-content/60 line-clamp-2 text-xs leading-relaxed">
                                                {cat.description}
                                            </p>
                                        </div>
                                    </div>
                                </a>
                            )
                        })
                    }
                </div>
            </div>
        </section>
    </main>
</Layout>
